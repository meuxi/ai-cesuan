"""
康熙字典笔画计算工具

用于姓名五格剖象法的笔画数计算
参考：康熙字典笔画规范
"""

import logging

_logger = logging.getLogger(__name__)

# 康熙字典笔画数映射表（简体字 -> 康熙笔画数）
# 包含常用姓氏和名字用字
STROKE_MAP = {
    # 常用姓氏 (按拼音排序)
    "艾": 8, "安": 6, "敖": 11, "巴": 4, "白": 5, "柏": 9, "班": 10,
    "包": 5, "鲍": 16, "贝": 7, "毕": 11, "卞": 4, "边": 18, "卜": 2,
    "蔡": 17, "曹": 11, "岑": 7, "柴": 9, "常": 11, "车": 7, "陈": 16,
    "成": 7, "程": 12, "池": 7, "仇": 4, "储": 18, "褚": 15, "崔": 11,
    "戴": 18, "单": 12, "邓": 19, "狄": 8, "刁": 2, "丁": 2, "董": 15,
    "窦": 20, "杜": 7, "段": 9, "范": 15, "方": 4, "房": 8, "费": 12,
    "冯": 12, "凤": 14, "伏": 6, "符": 11, "傅": 12, "甘": 5, "高": 10,
    "葛": 15, "耿": 10, "龚": 22, "巩": 15, "谷": 7, "顾": 21, "关": 19,
    "管": 14, "郭": 15, "韩": 17, "杭": 8, "郝": 14, "何": 7, "贺": 12,
    "洪": 10, "侯": 9, "胡": 11, "花": 10, "华": 14, "黄": 12, "霍": 16,
    "姬": 10, "嵇": 12, "吉": 6, "计": 9, "纪": 9, "季": 8, "贾": 13,
    "简": 18, "江": 7, "姜": 9, "蒋": 17, "焦": 12, "金": 8, "靳": 13,
    "荆": 12, "景": 12, "康": 11, "柯": 9, "孔": 4, "寇": 11, "匡": 6,
    "邝": 19, "赖": 16, "蓝": 20, "郎": 14, "劳": 12, "雷": 13, "冷": 7,
    "黎": 15, "李": 7, "廖": 14, "林": 8, "凌": 10, "刘": 15, "柳": 9,
    "龙": 16, "娄": 11, "卢": 16, "鲁": 15, "陆": 16, "路": 13, "吕": 7,
    "罗": 20, "骆": 16, "马": 10, "麦": 11, "满": 15, "毛": 4, "茅": 11,
    "梅": 11, "孟": 8, "米": 6, "苗": 11, "闵": 12, "明": 8, "莫": 13,
    "牟": 6, "穆": 16, "倪": 10, "聂": 18, "牛": 4, "钮": 12, "农": 13,
    "欧": 15, "潘": 16, "庞": 19, "裴": 14, "彭": 12, "皮": 5, "平": 5,
    "蒲": 16, "濮": 18, "戚": 11, "祁": 8, "齐": 14, "钱": 16, "强": 12,
    "乔": 12, "秦": 10, "邱": 11, "丘": 5, "曲": 6, "屈": 8, "权": 22,
    "全": 6, "阮": 12, "任": 6, "荣": 14, "容": 10, "汝": 7, "阮": 12,
    "芮": 10, "桑": 10, "沙": 8, "商": 11, "邵": 12, "沈": 8, "盛": 12,
    "施": 9, "石": 5, "史": 5, "舒": 12, "司": 5, "宋": 7, "苏": 22,
    "孙": 10, "索": 10, "谭": 19, "汤": 13, "唐": 10, "陶": 16, "滕": 15,
    "田": 5, "童": 12, "涂": 13, "屠": 11, "万": 15, "汪": 8, "王": 4,
    "韦": 9, "魏": 18, "卫": 15, "温": 14, "文": 4, "翁": 10, "邬": 15,
    "吴": 7, "伍": 6, "武": 8, "席": 10, "夏": 10, "项": 12, "向": 6,
    "萧": 18, "肖": 9, "谢": 17, "辛": 7, "邢": 11, "熊": 14, "徐": 10,
    "许": 11, "薛": 19, "荀": 12, "阎": 16, "严": 20, "颜": 18, "闫": 11,
    "杨": 13, "姚": 9, "叶": 15, "易": 8, "殷": 10, "尹": 4, "应": 17,
    "雍": 13, "尤": 4, "游": 13, "于": 3, "俞": 9, "虞": 13, "余": 7,
    "元": 4, "袁": 10, "岳": 17, "云": 12, "臧": 14, "曾": 12, "查": 9,
    "翟": 14, "詹": 13, "张": 11, "章": 11, "赵": 14, "甄": 14, "郑": 19,
    "支": 4, "钟": 17, "周": 8, "朱": 6, "祝": 10, "庄": 13, "卓": 8,
    "宗": 8, "邹": 17, "祖": 10, "左": 5,
    
    # 常用名字用字 (按拼音排序)
    "爱": 13, "霭": 24, "蔼": 22, "傲": 13, "奥": 13,
    "宝": 20, "碧": 14, "彬": 11, "斌": 11, "冰": 6, "波": 9, "博": 12,
    "才": 4, "彩": 11, "灿": 17, "超": 12, "晨": 11, "诚": 14, "澄": 16,
    "驰": 13, "冲": 8, "春": 9, "纯": 10, "慈": 14, "聪": 17, "翠": 14,
    "达": 16, "丹": 4, "德": 15, "迪": 12, "典": 8, "定": 8, "栋": 12,
    "东": 8, "冬": 5, "斗": 4,
    "恩": 10, "尔": 14, "珥": 11,
    "凡": 3, "芳": 10, "飞": 9, "菲": 14, "斐": 12, "丰": 18, "枫": 13,
    "风": 9, "锋": 15, "芙": 10, "福": 14, "富": 12,
    "刚": 10, "格": 10, "根": 10, "功": 5, "光": 6, "广": 15, "贵": 12,
    "国": 11, "果": 8,
    "海": 11, "涵": 12, "翰": 16, "瀚": 20, "豪": 14, "浩": 11, "皓": 12,
    "禾": 5, "和": 8, "荷": 13, "鹤": 21, "恒": 10, "弘": 5, "虹": 9,
    "宏": 7, "红": 9, "洪": 10, "惠": 12, "慧": 15, "辉": 15, "晖": 13,
    "佳": 8, "嘉": 14, "家": 10, "健": 11, "建": 9, "杰": 12, "洁": 16,
    "锦": 16, "瑾": 16, "进": 15, "晋": 10, "京": 8, "菁": 14, "精": 14,
    "静": 16, "婧": 11, "敬": 13, "靖": 13, "镜": 19, "久": 3, "玖": 8,
    "军": 9, "君": 7, "俊": 9, "骏": 17, "峻": 10,
    "凯": 12, "楷": 13, "恺": 14, "开": 12, "科": 9, "可": 5, "珂": 10,
    "坤": 8, "昆": 8, "琨": 13,
    "兰": 23, "岚": 12, "澜": 21, "磊": 15, "蕾": 19, "乐": 15, "雷": 13,
    "蕊": 18, "芮": 10, "瑞": 14, "睿": 14, "若": 11, "润": 16,
    "丽": 19, "莉": 13, "俐": 9, "莲": 17, "廉": 13, "良": 7, "亮": 9,
    "林": 8, "琳": 13, "霖": 16, "灵": 24, "玲": 10, "凌": 10, "龄": 20,
    "柳": 9, "璐": 18, "露": 20, "路": 13, "伦": 10, "珞": 11,
    "美": 9, "梦": 14, "妙": 7, "敏": 11, "明": 8, "铭": 14, "茗": 12,
    "慕": 15, "木": 4, "牧": 8, "沐": 8, "睦": 13,
    "娜": 10, "楠": 13, "南": 9, "妮": 8, "宁": 14, "凝": 16, "诺": 16,
    "鹏": 19, "朋": 8, "佩": 8, "沛": 8, "培": 11, "品": 9, "萍": 14,
    "璞": 17, "濮": 18,
    "琦": 13, "祺": 13, "琪": 13, "淇": 12, "琪": 13, "启": 11, "芊": 9,
    "茜": 12, "谦": 17, "巧": 5, "俏": 9, "芹": 10, "勤": 13, "青": 8,
    "晴": 12, "清": 12, "庆": 15, "琼": 20, "秋": 9, "泉": 9, "权": 22,
    "群": 13,
    "然": 12, "仁": 4, "荣": 14, "蓉": 16, "榕": 14, "柔": 9, "儒": 16,
    "茹": 12, "如": 6,
    "森": 12, "善": 12, "珊": 10, "山": 3, "杉": 7, "尚": 8, "韶": 14,
    "绍": 11, "诗": 13, "施": 9, "识": 19, "世": 5, "仕": 5, "书": 10,
    "姝": 9, "淑": 12, "舒": 12, "曙": 18, "帅": 9, "双": 18, "顺": 12,
    "思": 9, "斯": 12, "颂": 13, "松": 18, "嵩": 13, "诵": 14,
    "涛": 18, "桃": 10, "陶": 16, "天": 4, "甜": 11, "恬": 10, "婷": 12,
    "亭": 9, "廷": 7, "庭": 10, "彤": 7, "童": 12, "桐": 10, "铜": 14,
    "潼": 16, "通": 14,
    "薇": 19, "巍": 21, "伟": 11, "维": 14, "炜": 13, "纬": 15, "蔚": 17,
    "玮": 14, "文": 4, "雯": 12, "闻": 14, "稳": 19, "武": 8,
    "曦": 20, "西": 6, "希": 7, "昔": 8, "熙": 13, "溪": 14, "惜": 12,
    "锡": 16, "熹": 16, "喜": 12, "禧": 17, "霞": 17, "夏": 10, "贤": 15,
    "娴": 15, "显": 23, "宪": 16, "香": 9, "湘": 13, "祥": 11, "翔": 12,
    "想": 13, "响": 22, "晓": 16, "孝": 7, "效": 10, "笑": 10, "欣": 8,
    "馨": 20, "新": 13, "鑫": 24, "信": 9, "星": 9, "兴": 16, "行": 6,
    "形": 7, "醒": 16, "杏": 7, "幸": 8, "雄": 12, "秀": 7, "绣": 13,
    "旭": 6, "序": 7, "绪": 14, "轩": 10, "宣": 9, "萱": 15, "暄": 13,
    "煊": 13, "璇": 16, "选": 19, "学": 16, "雪": 11, "勋": 16, "熏": 14,
    "雅": 12, "亚": 8, "延": 7, "妍": 7, "言": 7, "岩": 8, "研": 11,
    "彦": 9, "焱": 12, "艳": 24, "燕": 16, "晏": 10, "阳": 17, "扬": 13,
    "洋": 10, "漾": 15, "尧": 12, "瑶": 15, "耀": 20, "业": 13, "烨": 14,
    "一": 1, "伊": 6, "依": 8, "怡": 9, "宜": 8, "仪": 15, "颐": 16,
    "益": 10, "逸": 15, "意": 13, "毅": 15, "翊": 11, "奕": 9, "熠": 15,
    "懿": 22, "因": 6, "音": 9, "殷": 10, "银": 14, "寅": 11, "引": 4,
    "英": 11, "盈": 9, "莹": 15, "萦": 14, "颖": 16, "映": 9, "永": 5,
    "咏": 9, "勇": 9, "涌": 11, "悠": 11, "尤": 4, "由": 5, "佑": 7,
    "幼": 5, "余": 7, "予": 4, "愉": 13, "渝": 13, "瑜": 14, "雨": 8,
    "语": 14, "羽": 6, "宇": 6, "玉": 5, "育": 10, "郁": 13, "煜": 13,
    "誉": 21, "豫": 16, "渊": 12, "源": 14, "远": 17, "苑": 11, "媛": 12,
    "缘": 15, "圆": 13, "元": 4, "园": 13, "原": 10, "援": 13, "月": 4,
    "玥": 9, "悦": 11, "越": 12, "跃": 21, "云": 12, "芸": 10, "韵": 19,
    "蕴": 22,
    "在": 6, "泽": 17, "增": 15, "战": 16, "瞻": 18, "展": 10, "章": 11,
    "昭": 9, "兆": 6, "哲": 10, "真": 10, "振": 11, "镇": 18, "正": 5,
    "政": 8, "之": 4, "芝": 10, "知": 8, "志": 7, "智": 12, "治": 9,
    "中": 4, "忠": 8, "仲": 6, "众": 11, "舟": 6, "洲": 10, "周": 8,
    "珠": 11, "竹": 6, "卓": 8, "姿": 9, "子": 3, "紫": 11, "梓": 11,
    "自": 6, "宗": 8, "祖": 10, "佐": 7, "作": 7, "祚": 10,
}

# 特殊部首康熙笔画修正（简体部首 -> 康熙笔画数）
RADICAL_CORRECTIONS = {
    "氵": 4,   # 三点水按水计算
    "扌": 4,   # 提手旁按手计算
    "忄": 4,   # 竖心旁按心计算
    "犭": 4,   # 反犬旁按犬计算
    "礻": 5,   # 示字旁按示计算
    "王": 5,   # 斜玉旁按玉计算
    "艹": 6,   # 草字头按草计算
    "衤": 6,   # 衣字旁按衣计算
    "月": 6,   # 肉月旁按肉计算
    "辶": 7,   # 走之底按辵计算
    "阝": 8,   # 左耳旁按阜计算（右耳旁按邑7画）
}


def get_kangxi_stroke(char: str) -> int:
    """
    获取汉字的康熙字典笔画数
    
    Args:
        char: 单个汉字
        
    Returns:
        笔画数，如果未找到则返回-1
    """
    if char in STROKE_MAP:
        return STROKE_MAP[char]
    
    # 未收录的字，返回-1表示需要AI辅助
    _logger.warning(f"未找到汉字 '{char}' 的康熙笔画数，将由AI辅助计算")
    return -1


def calculate_five_grids(name: str) -> dict:
    """
    计算姓名五格
    
    五格计算规则：
    - 天格：单姓=姓氏笔画+1，复姓=姓氏笔画之和
    - 人格：姓氏末字笔画 + 名字首字笔画
    - 地格：名字笔画之和（单名+1）
    - 外格：总格 - 人格 + 1（单姓单名=2）
    - 总格：姓名所有笔画之和
    
    Args:
        name: 完整姓名（2-4个字）
        
    Returns:
        包含五格数理和详细信息的字典
    """
    if len(name) < 2 or len(name) > 4:
        return {"error": "姓名长度应为2-4个字"}
    
    # 判断姓氏长度（简单规则：常见复姓判断）
    common_compound_surnames = [
        "欧阳", "司马", "上官", "诸葛", "东方", "独孤", "慕容", "皇甫",
        "令狐", "轩辕", "公孙", "宇文", "长孙", "司徒", "端木", "南宫"
    ]
    
    surname_len = 1
    for compound in common_compound_surnames:
        if name.startswith(compound):
            surname_len = 2
            break
    
    surname = name[:surname_len]
    given_name = name[surname_len:]
    
    if not given_name:
        return {"error": "名字不能为空"}
    
    # 计算各字笔画
    surname_strokes = [get_kangxi_stroke(c) for c in surname]
    given_name_strokes = [get_kangxi_stroke(c) for c in given_name]
    
    # 检查是否有未找到的字
    all_found = all(s > 0 for s in surname_strokes + given_name_strokes)
    
    # 天格计算
    if surname_len == 1:
        tian_ge = surname_strokes[0] + 1 if surname_strokes[0] > 0 else -1
    else:
        tian_ge = sum(s for s in surname_strokes if s > 0) if all(s > 0 for s in surname_strokes) else -1
    
    # 人格计算：姓氏末字 + 名字首字
    ren_ge = -1
    if surname_strokes[-1] > 0 and given_name_strokes[0] > 0:
        ren_ge = surname_strokes[-1] + given_name_strokes[0]
    
    # 地格计算
    if len(given_name_strokes) == 1:
        di_ge = given_name_strokes[0] + 1 if given_name_strokes[0] > 0 else -1
    else:
        di_ge = sum(s for s in given_name_strokes if s > 0) if all(s > 0 for s in given_name_strokes) else -1
    
    # 总格计算
    all_strokes = surname_strokes + given_name_strokes
    zong_ge = sum(s for s in all_strokes if s > 0) if all(s > 0 for s in all_strokes) else -1
    
    # 外格计算
    wai_ge = -1
    if zong_ge > 0 and ren_ge > 0:
        wai_ge = zong_ge - ren_ge + 1
        if wai_ge < 2:
            wai_ge = 2
    
    # 构建结果
    result = {
        "姓氏": surname,
        "名字": given_name,
        "姓氏笔画": surname_strokes,
        "名字笔画": given_name_strokes,
        "天格": tian_ge,
        "人格": ren_ge,
        "地格": di_ge,
        "外格": wai_ge,
        "总格": zong_ge,
        "笔画全部识别": all_found,
    }
    
    # 添加五行属性
    def get_wuxing(num: int) -> str:
        if num < 0:
            return "未知"
        remainder = num % 10
        if remainder in [1, 2]:
            return "木"
        elif remainder in [3, 4]:
            return "火"
        elif remainder in [5, 6]:
            return "土"
        elif remainder in [7, 8]:
            return "金"
        else:  # 9, 0
            return "水"
    
    result["天格五行"] = get_wuxing(tian_ge)
    result["人格五行"] = get_wuxing(ren_ge)
    result["地格五行"] = get_wuxing(di_ge)
    result["外格五行"] = get_wuxing(wai_ge)
    result["总格五行"] = get_wuxing(zong_ge)
    
    # 三才配置
    result["三才配置"] = f"{result['天格五行']}-{result['人格五行']}-{result['地格五行']}"
    
    return result


def format_five_grids_prompt(name: str) -> str:
    """
    格式化五格信息为AI提示词
    
    Args:
        name: 完整姓名
        
    Returns:
        格式化的提示词字符串
    """
    grids = calculate_five_grids(name)
    
    if "error" in grids:
        return f"姓名分析错误：{grids['error']}"
    
    # 构建提示词
    lines = [
        f"姓名：{name}",
        f"姓氏：{grids['姓氏']}（笔画：{grids['姓氏笔画']}）",
        f"名字：{grids['名字']}（笔画：{grids['名字笔画']}）",
        "",
        "【五格数理】",
    ]
    
    if grids["笔画全部识别"]:
        lines.extend([
            f"- 天格：{grids['天格']}（{grids['天格五行']}）",
            f"- 人格：{grids['人格']}（{grids['人格五行']}）", 
            f"- 地格：{grids['地格']}（{grids['地格五行']}）",
            f"- 外格：{grids['外格']}（{grids['外格五行']}）",
            f"- 总格：{grids['总格']}（{grids['总格五行']}）",
            "",
            f"【三才配置】{grids['三才配置']}",
            "",
            "请根据以上五格数理进行详细分析。",
        ])
    else:
        lines.extend([
            "（部分汉字笔画未能自动识别，请根据康熙字典标准计算后分析）",
            f"- 天格：{grids['天格'] if grids['天格'] > 0 else '待计算'}",
            f"- 人格：{grids['人格'] if grids['人格'] > 0 else '待计算'}",
            f"- 地格：{grids['地格'] if grids['地格'] > 0 else '待计算'}",
            f"- 外格：{grids['外格'] if grids['外格'] > 0 else '待计算'}",
            f"- 总格：{grids['总格'] if grids['总格'] > 0 else '待计算'}",
            "",
            "请先根据康熙字典确认各字笔画数，然后进行五格分析。",
        ])
    
    return "\n".join(lines)
