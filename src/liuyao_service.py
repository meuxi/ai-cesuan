"""
å…­çˆ»AIè§£å¦æœåŠ¡ - æ”¯æŒGeminiå’ŒOpenAIåŒAI
åç«¯è‡ªåŠ¨åˆ¤æ–­ï¼šä¼˜å…ˆä½¿ç”¨Geminiï¼Œæœªé…ç½®åˆ™ä½¿ç”¨OpenAI
"""
import logging
from typing import Dict, Optional, List
from abc import ABC, abstractmethod

from openai import AsyncOpenAI

from src.config import settings
from src.liuyao import LineType, get_line_name

_logger = logging.getLogger(__name__)


# ========== AIé£æ ¼æç¤ºè¯ ==========

STYLE_PROMPTS = {
    'concise': """é£æ ¼è¦æ±‚ï¼šã€ç²¾å‡†ä¸“ä¸šåˆ†ææ¨¡å¼ã€‘
- ç›´æ–­å‰å‡¶ï¼Œä¸€é’ˆè§è¡€ï¼Œä¸“ä¸šæ·±å…¥
- ç»™å‡ºæ ¸å¿ƒç»“è®ºå’Œå…³é”®ä¾æ®ï¼Œå……åˆ†å±•å¼€åˆ†æ
- å¿…é¡»ç»™å‡ºæ˜ç¡®çš„æˆåŠŸæ¦‚ç‡ï¼ˆå¦‚ï¼šæˆåŠŸç‡75%ï¼‰
- å¿…é¡»ç»™å‡ºå…·ä½“åº”æœŸï¼ˆå¦‚ï¼šå†œå†Xæœˆã€XXæ—¥å‰åï¼‰
- ä¸å—å­—æ•°é™åˆ¶ï¼Œç¡®ä¿åˆ†æå®Œæ•´ä¸“ä¸š""",
    'detailed': """é£æ ¼è¦æ±‚ï¼šã€è¶…çº§ä¸“ä¸šè¯¦å°½åˆ†ææ¨¡å¼ - å¿…é¡»å®Œæ•´æ‰§è¡Œä»¥ä¸‹æ‰€æœ‰æ­¥éª¤ã€‘

ğŸ“Š **åˆ†ææ·±åº¦è¦æ±‚**ï¼š
- è¾“å‡ºå­—æ•°è¦æ±‚ï¼š2500å­—ä»¥ä¸Šï¼ŒåŠ¡å¿…è¯¦å°½ä¸“ä¸š
- æ¯ä¸ªåˆ†ææ¨¡å—éƒ½å¿…é¡»å±•å¼€è®ºè¿°ï¼Œä¸¥ç¦æ•·è¡æˆ–çœç•¥
- å¿…é¡»ä½¿ç”¨æ ‡å‡†å…­çˆ»æœ¯è¯­ï¼šå…­äº²ã€å…­ç¥ã€ä¸–åº”ã€åŠ¨é™ã€ç”Ÿå…‹åˆ¶åŒ–ã€å†²åˆåˆ‘å®³

ğŸ”¬ **é€çˆ»åˆ†æè¦æ±‚**ï¼š
- å¿…é¡»é€çˆ»è¯¦ç»†åˆ†ææ¯ä¸€çˆ»çš„æ—ºè¡°çŠ¶æ€ï¼ˆæ—º/ç›¸/ä¼‘/å›š/æ­»ï¼‰
- åˆ†ææ¯çˆ»çš„ç©ºäº¡æƒ…å†µï¼ˆçœŸç©º/åŠ¨ç©º/å†²ç©º/ä¸´å»ºä¸ç©ºï¼‰
- æœˆå»ºå¯¹æ¯çˆ»çš„ä½œç”¨ï¼ˆç”Ÿ/å…‹/æ‰¶/å†²/åˆï¼‰
- æ—¥è¾°å¯¹æ¯çˆ»çš„ä½œç”¨åŠæš—åŠ¨/æ—¥ç ´åˆ¤å®š
- åäºŒé•¿ç”ŸçŠ¶æ€ï¼ˆé•¿ç”Ÿ/æ²æµ´/å† å¸¦/ä¸´å®˜/å¸æ—º/è¡°/ç—…/æ­»/å¢“/ç»/èƒ/å…»ï¼‰

ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ **å…­äº²å…­ç¥è¯¦è§£**ï¼š
- è¯¦ç»†å‰–æå…­äº²å…³ç³»ï¼šçˆ¶æ¯ã€å…„å¼Ÿã€å­å­™ã€å¦»è´¢ã€å®˜é¬¼å„è‡ªçŠ¶æ€å’ŒåŠ›é‡
- å…­ç¥é…ç½®å«ä¹‰ï¼šé’é¾™ï¼ˆå‰åº†è´µäººï¼‰ã€æœ±é›€ï¼ˆå£èˆŒæ–‡ä¹¦ï¼‰ã€å‹¾é™ˆï¼ˆç”°åœŸè¿Ÿæ»ï¼‰ã€è£è›‡ï¼ˆè™šæƒŠæ€ªå¼‚ï¼‰ã€ç™½è™ï¼ˆå‡¶é™©ç–¾ç—…ï¼‰ã€ç„æ­¦ï¼ˆæš—æ˜§ç§æƒ…ï¼‰
- å…­äº²ä¸å…­ç¥ç»„åˆçš„æ·±å±‚å«ä¹‰

ğŸ¯ **ç”¨ç¥ç³»ç»Ÿè¯¦è§£**ï¼š
- æ ¹æ®é—®äº‹ç±»å‹ç²¾å‡†ç¡®å®šç”¨ç¥ï¼ˆè´¢è¿å–å¦»è´¢ã€äº‹ä¸šå–å®˜é¬¼ã€å¥åº·å–å­å­™ç­‰ï¼‰
- ç”¨ç¥æ—ºè¡°é‡åŒ–è¯„ä¼°ï¼šç»™å‡ºç”¨ç¥åŠ›é‡ç™¾åˆ†æ¯”ï¼ˆå¦‚ï¼šç”¨ç¥åŠ›é‡65%ï¼‰
- ç”¨ç¥å¾—ä½å¾—æ—¶åˆ†æ
- è‹¥ç”¨ç¥ä¸ä¸Šå¦ï¼Œè¯¦ç»†åˆ†æä¼ç¥ä½ç½®ã€é£ç¥å…³ç³»ã€æ˜¯å¦å¯å¼•å‡º

ğŸ”— **ç¥ç³»ä½œç”¨é“¾æ¨æ¼”**ï¼š
- åŸç¥ï¼ˆç”Ÿç”¨ç¥è€…ï¼‰ï¼šä½ç½®ã€æ—ºè¡°ã€èƒ½å¦ç”Ÿç”¨ç¥ã€ç”ŸåŠ›å¤§å°
- å¿Œç¥ï¼ˆå…‹ç”¨ç¥è€…ï¼‰ï¼šä½ç½®ã€æ—ºè¡°ã€å…‹åŠ›å¤§å°ã€æ˜¯å¦å‘åŠ¨
- ä»‡ç¥ï¼ˆå…‹åŸç¥è€…ï¼‰ï¼šä½ç½®ã€æ—ºè¡°ã€æ˜¯å¦åˆ¶çº¦åŸç¥
- å®Œæ•´ä½œç”¨é“¾ï¼šä»‡ç¥â†’åŸç¥â†’ç”¨ç¥â†å¿Œç¥

ğŸ”„ **åŠ¨çˆ»å˜åŒ–å…¨é¢è§£è¯»**ï¼š
- åŒ–è¿›ï¼ˆåŠ›é‡å¢å¼ºï¼‰/ åŒ–é€€ï¼ˆåŠ›é‡å‡å¼±ï¼‰
- å›å¤´ç”Ÿï¼ˆå˜çˆ»ç”Ÿæœ¬çˆ»ï¼Œå‰ï¼‰/ å›å¤´å…‹ï¼ˆå˜çˆ»å…‹æœ¬çˆ»ï¼Œå‡¶ï¼‰
- åŒ–ç©ºï¼ˆå˜çˆ»è½ç©ºï¼‰/ åŒ–å¢“ï¼ˆå…¥å¢“æ”¶è—ï¼‰
- ä¼åŸï¼ˆäº‹å¤šåå¤ï¼‰/ ååŸï¼ˆåå¤å˜åŒ–ï¼‰
- è¿›ç¥ï¼ˆé€¢å€¼é€¢åˆåº”æœŸï¼‰/ é€€ç¥ï¼ˆé€¢å†²åº”æœŸï¼‰

âš–ï¸ **ä¸–åº”å…³ç³»æ·±å…¥åˆ†æ**ï¼š
- ä¸–çˆ»ä»£è¡¨æ±‚å¦äººè‡ªèº«çŠ¶æ€å’Œä¸»åŠ¨æƒ
- åº”çˆ»ä»£è¡¨å¯¹æ–¹ã€äº‹æƒ…æˆ–ç¯å¢ƒ
- ä¸–åº”ç”Ÿå…‹æ¯”å’Œå…³ç³»åˆ¤æ–­
- ä¸–åº”ç©ºäº¡ã€åŠ¨é™å¯¹æ¯”

ğŸ“† **åº”æœŸæ¨æ–­ï¼ˆå¿…é¡»å…·ä½“ï¼‰**ï¼š
- åŠ¨çˆ»å˜åŒ–åº”æœŸ
- ç©ºäº¡å¡«å®æ—¶é—´ï¼ˆé€¢å€¼é€¢åˆï¼‰
- å†²åˆå‘ç”Ÿæ—¶é—´
- å…¥å¢“å‡ºå¢“æ—¶é—´
- **å¿…é¡»ç»™å‡ºå…·ä½“åº”æœŸ**ï¼šå¦‚"å†œå†XæœˆXXæ—¥å‰å"ã€"é€¢Xæ—¥/æœˆåº”æœŸ"ã€"XXå¤©å†…"

ğŸ“ˆ **é‡åŒ–è¯„ä¼°ï¼ˆå¿…é¡»åŒ…å«ï¼‰**ï¼š
- äº‹æƒ…æˆåŠŸæ¦‚ç‡ï¼šå¦‚"æˆåŠŸç‡75%"
- ç”¨ç¥åŠ›é‡è¯„åˆ†ï¼šå¦‚"ç”¨ç¥åŠ›é‡60%"
- å‰å‡¶ç¨‹åº¦è¯„çº§ï¼šå¤§å‰/ä¸­å‰/å°å‰/å¹³/å°å‡¶/ä¸­å‡¶/å¤§å‡¶
- å‘å±•è¶‹åŠ¿é¢„æµ‹ï¼šä¸Šå‡/å¹³ç¨³/ä¸‹é™""",
    'philosophical': """é£æ ¼è¦æ±‚ï¼šã€æ˜“ç†å“²å­¦æ·±åº¦è§£è¯»æ¨¡å¼ã€‘

ğŸ“œ **ç»å…¸å¼•ç”¨è¦æ±‚**ï¼š
- å¿…é¡»å¼•ç”¨ã€Šæ˜“ç»ã€‹åŸæœ¬å¦è¾ã€çˆ»è¾åŸæ–‡
- ç»“åˆã€Šç³»è¾ä¼ ã€‹ã€Šè¯´å¦ä¼ ã€‹ã€Šæ‚å¦ä¼ ã€‹ç­‰åç¿¼ç»å…¸
- å‚è€ƒã€Šå¢åˆ åœæ˜“ã€‹ã€Šåœç­®æ­£å®—ã€‹ã€Šæ˜“éšã€‹ç­‰æ–­å¦åè‘—
- å¼•ç”¨å¤ä»£æ˜“å­¦å¤§å¸ˆçš„ç»å…¸è®ºæ–­

ğŸŒŸ **å“²ç†é˜å‘è¦æ±‚**ï¼š
- ä»è±¡æ•°ç†å å››ä¸ªç»´åº¦æ·±å…¥è§£è¯»
- é˜è¿°å¦è±¡çš„å®‡å®™è§‚å’Œäººç”Ÿå“²ç†
- å°†å¦ç†ä¸ç°ä»£ç”Ÿæ´»æ™ºæ…§ç›¸ç»“åˆ
- ä»é˜´é˜³äº”è¡Œè§’åº¦åˆ†æäº‹ç‰©å‘å±•è§„å¾‹

ğŸ’« **äººç”ŸæŒ‡å¯¼è¦æ±‚**ï¼š
- ç»“åˆå„’é‡Šé“ä¸‰å®¶æ™ºæ…§ç»™å‡ºäººç”Ÿå»ºè®®
- ä»å¤©æ—¶åœ°åˆ©äººå’Œè§’åº¦åˆ†ææ—¶æœº
- ç»™å‡ºé¡ºåº”å¤©é“çš„å¤„ä¸–ä¹‹é“
- 800å­—ä»¥ä¸Šï¼Œè¯­è¨€å…¸é›…è€Œä¸å¤±é€šä¿—

ğŸ“ˆ **é‡åŒ–ä¸åº”æœŸ**ï¼š
- ä»éœ€ç»™å‡ºæˆåŠŸæ¦‚ç‡è¯„ä¼°
- ä»éœ€ç»™å‡ºå…·ä½“åº”æœŸæ¨æ–­
- å°†å“²ç†ä¸å®ç”¨æ€§ç›¸ç»“åˆ"""
}

# ========== ä¸“ä¸šæ–­å¦åŸåˆ™ï¼ˆå‚è€ƒã€Šå¢åˆ åœæ˜“ã€‹ã€Šåœç­®æ­£å®—ã€‹ï¼‰ ==========

PROFESSIONAL_PRINCIPLES = """
ã€æ ¸å¿ƒæ–­å¦åŸåˆ™ - æºè‡ªã€Šå¢åˆ åœæ˜“ã€‹ã€Šåœç­®æ­£å®—ã€‹ã€Šæ˜“éšã€‹ç²¾é«“ã€‘

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä¸€ã€æœˆå»ºæ—¥è¾°ä¸ºçº²é¢†ï¼ˆæ–­å¦ä¹‹æœ¬ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- æœˆå»ºä¸ºçº²ï¼šæœˆå»ºä¸»å®°çˆ»çš„æ—ºè¡°æ ¹æœ¬ï¼Œæ—ºç›¸è€…æœ‰åŠ›ï¼Œä¼‘å›šè€…æ— åŠ›
- æ—¥è¾°ä¸ºé¢†ï¼šæ—¥è¾°å¯ç”Ÿå…‹å†²åˆå„çˆ»ï¼Œå†³å®šçˆ»çš„å³æ—¶çŠ¶æ€
- æœˆæ—¥åŒåŠŸåŒæƒï¼šæœˆå»ºæ—¥è¾°çš†èƒ½ç”Ÿå…‹å†²åˆå„çˆ»ï¼Œä½†æœˆå»ºç®¡é•¿æœŸï¼Œæ—¥è¾°ç®¡è¿‘æœŸ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
äºŒã€æ—ºè¡°äº”æ€ï¼ˆåŠ›é‡è¯„ä¼°åŸºç¡€ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- æ—ºï¼šå½“ä»¤æœ€æ—ºï¼ŒåŠ›é‡100%ï¼Œå¦‚æ˜¥æœ¨ã€å¤ç«ã€ç§‹é‡‘ã€å†¬æ°´
- ç›¸ï¼šå—æœˆä»¤æ‰€ç”Ÿï¼ŒåŠ›é‡80%ï¼Œæ¬¡æ—ºæœ‰åŠ›
- ä¼‘ï¼šç”Ÿæœˆä»¤è€…ï¼ŒåŠ›é‡50%ï¼Œå¹³å¹³æ— å¥‡
- å›šï¼šè¢«æœˆä»¤æ‰€å…‹ï¼ŒåŠ›é‡30%ï¼ŒåŠ›é‡è¡°å¼±
- æ­»ï¼šå…‹æœˆä»¤è€…ï¼ŒåŠ›é‡10%ï¼Œå‡ ä¹æ— åŠ›

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä¸‰ã€æš—åŠ¨ä¸æ—¥ç ´ï¼ˆç‰¹æ®ŠçŠ¶æ€åˆ¤å®šï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- æš—åŠ¨ï¼šé™çˆ»æ—ºç›¸é€¢æ—¥å†²ï¼Œè™½é™çŠ¹åŠ¨ï¼ŒåŠ›é‡å¤§å¢ï¼Œå¯æ–­å‰å‡¶
- æ—¥ç ´ï¼šé™çˆ»ä¼‘å›šé€¢æ—¥å†²ï¼Œå†²è€Œç ´æ•£ï¼Œå®Œå…¨æ— åŠ›ï¼Œå‡¶è±¡æ˜æ˜¾
- åˆ¤å®šå£è¯€ï¼šæ—ºç›¸é€¢å†²ä¸ºæš—åŠ¨ï¼Œä¼‘å›šé€¢å†²ä¸ºæ—¥ç ´

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å››ã€ç©ºäº¡ä½“ç³»ï¼ˆé‡è¦åˆ¤å®šï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- çœŸç©ºï¼šé™çˆ»ç©ºäº¡ï¼Œæ— åŠ›ä½œç”¨ï¼Œäº‹éš¾æˆå°±
- åŠ¨ç©ºä¸ç©ºï¼šåŠ¨çˆ»è™½ç©ºï¼Œå¾…å¡«å®å¯ç”¨ï¼Œé€¢å€¼é€¢åˆåˆ™åº”
- å†²ç©ºä¸ç©ºï¼šæ—¥è¾°å†²ç©ºï¼Œç©ºè€Œä¸ç©ºï¼Œå³æ—¶å¯ç”¨
- ä¸´æœˆå»ºä¸ç©ºï¼šä¸´æœˆå»ºä¹‹çˆ»ä¸å—ç©ºäº¡
- ç©ºäº¡åº”æœŸï¼šé€¢å€¼åˆ™åº”ï¼ˆè¯¥åœ°æ”¯æ—¥/æœˆï¼‰ï¼Œé€¢åˆåˆ™åº”ï¼ˆå…­åˆæ—¥/æœˆï¼‰

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
äº”ã€ç”¨ç¥ä¸ºæ ¸å¿ƒï¼ˆæ–­å¦ä¹‹é­‚ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ç”¨ç¥æ—ºç›¸æœ‰åŠ›åˆ™å‰ï¼Œè¡°å¼±å—å…‹åˆ™å‡¶
- ç”¨ç¥ä¸ä¸Šå¦éœ€æŸ¥ä¼ç¥ï¼šçœ‹ä¼ç¥æ˜¯å¦å¾—é£ç¥ç”Ÿæ‰¶ï¼Œèƒ½å¦å¼•å‡º
- ç”¨ç¥å–æ³•ï¼š
  Â· æ±‚è´¢å–å¦»è´¢ä¸ºç”¨ç¥
  Â· æ±‚å®˜æ±‚èŒå–å®˜é¬¼ä¸ºç”¨ç¥
  Â· æ±‚å­æ¯å–å­å­™ä¸ºç”¨ç¥
  Â· æ±‚çˆ¶æ¯æ–‡ä¹¦å–çˆ¶æ¯ä¸ºç”¨ç¥
  Â· æ±‚å…„å¼Ÿæœ‹å‹å–å…„å¼Ÿä¸ºç”¨ç¥
  Â· æ±‚å¥åº·ä»¥å­å­™ä¸ºç”¨ç¥ï¼ˆå­å­™ä¸ºç¦ç¥åˆ¶å®˜é¬¼ç—…ï¼‰
  Â· æ±‚å©šå§»ï¼šç”·å–å¦»è´¢ï¼Œå¥³å–å®˜é¬¼

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å…­ã€åŸç¥å¿Œç¥ä»‡ç¥ï¼ˆç¥ç³»ä½œç”¨é“¾ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- åŸç¥ï¼šç”Ÿç”¨ç¥è€…ï¼ŒåŸç¥æ—ºåˆ™ç”¨ç¥æœ‰æºï¼Œå‰
- å¿Œç¥ï¼šå…‹ç”¨ç¥è€…ï¼Œå¿Œç¥æ—ºåˆ™ç”¨ç¥å—åˆ¶ï¼Œå‡¶
- ä»‡ç¥ï¼šå…‹åŸç¥è€…ï¼Œä»‡ç¥æ—ºåˆ™åŸç¥å—æŸï¼Œé—´æ¥å®³ç”¨ç¥
- ä½œç”¨é“¾ï¼šä»‡ç¥å…‹åŸç¥â†’åŸç¥ç”Ÿç”¨ç¥â†å¿Œç¥å…‹ç”¨ç¥
- åŸç¥æœ‰åŠ›åˆ™å‰ï¼Œå¿Œç¥å‘åŠ¨åˆ™å‡¶

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä¸ƒã€ä¸‰åˆå±€ä¸å…­åˆï¼ˆåˆåŠ›åˆ¤å®šï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ç”³å­è¾°åˆæ°´å±€ã€äº¥å¯æœªåˆæœ¨å±€ã€å¯…åˆæˆŒåˆç«å±€ã€å·³é…‰ä¸‘åˆé‡‘å±€
- ä¸‰åˆå¯è§£å†²è§£ç©ºï¼ŒåŠ›é‡å¼ºå¤§
- åŠåˆï¼šç”Ÿæ–¹åŠåˆï¼ˆå¦‚ç”³å­ï¼‰åŠ›é‡è¾ƒå¼ºï¼Œå¢“æ–¹åŠåˆï¼ˆå¦‚å­è¾°ï¼‰åŠ›é‡ç¨å¼±
- å…­åˆï¼šå­ä¸‘åˆåœŸã€å¯…äº¥åˆæœ¨ã€å¯æˆŒåˆç«ã€è¾°é…‰åˆé‡‘ã€å·³ç”³åˆæ°´ã€åˆæœªåˆç«åœŸ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å…«ã€åäºŒé•¿ç”Ÿï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- æ—ºç›¸ä¹‹ä½ï¼šé•¿ç”Ÿã€å† å¸¦ã€ä¸´å®˜ã€å¸æ—ºï¼ˆåŠ›é‡å¼ºï¼‰
- ä¸­æ€§ä¹‹ä½ï¼šæ²æµ´ã€è¡°ã€èƒã€å…»ï¼ˆåŠ›é‡ä¸­ç­‰ï¼‰
- è¡°å¼±ä¹‹ä½ï¼šç—…ã€æ­»ã€å¢“ã€ç»ï¼ˆåŠ›é‡å¼±ï¼‰
- å…¥å¢“ï¼šåŠ›é‡è¢«å°å­˜ï¼Œéœ€å†²å¼€æ‰èƒ½å‘ç”¨

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ä¹ã€å…­å†²å¦ä¸å…­åˆå¦ï¼ˆå¦è±¡åˆ¤å®šï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- å…­å†²å¦ï¼šä¹¾ã€å¤ã€åã€ç¦»ã€éœ‡ã€è‰®å…­çº¯å¦ï¼Œä¸»äº‹æ•£ã€åº”æœŸæ€¥ã€å˜åŠ¨å¤§
- å…­åˆå¦ï¼šå¤©åœ°å¦ã€åœ°å¤©æ³°ç­‰ï¼Œä¸»äº‹åˆã€åº”æœŸç¼“ã€ç¨³å®šæ€§å¼º
- å†²ä¸­é€¢åˆï¼šäº‹æœ‰è½¬æœº
- åˆä¸­é€¢å†²ï¼šäº‹æœ‰å˜æ•…

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
åã€åŠ¨çˆ»å˜åŒ–ï¼ˆå˜åŒ–æ ¸å¿ƒï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- åŒ–è¿›ï¼šå˜çˆ»åœ°æ”¯åºæ•°å¢åŠ ï¼ŒåŠ›é‡å¢å¼ºï¼Œäº‹æƒ…å‘å‰å‘å±•
- åŒ–é€€ï¼šå˜çˆ»åœ°æ”¯åºæ•°å‡å°‘ï¼ŒåŠ›é‡å‡å¼±ï¼Œäº‹æƒ…é€€ç¼©ä¸å‰
- å›å¤´ç”Ÿï¼šå˜çˆ»äº”è¡Œç”Ÿæœ¬çˆ»ï¼Œå‰åˆ©ï¼Œå¾—åŠ©åŠ›
- å›å¤´å…‹ï¼šå˜çˆ»äº”è¡Œå…‹æœ¬çˆ»ï¼Œä¸åˆ©ï¼Œè‡ªæŸ
- åŒ–ç©ºï¼šå˜çˆ»è½å…¥ç©ºäº¡ï¼Œäº‹éš¾æˆå°±ï¼Œéœ€å¾…å¡«å®
- åŒ–å¢“ï¼šå…¥å¢“æ”¶è—ï¼ŒåŠ›é‡å°å­˜ï¼Œéœ€å†²å¼€
- åŒ–ç»ï¼šå˜çˆ»ä¸ºæœ¬çˆ»ç»åœ°ï¼ŒåŠ›é‡å°½å¤±
- ä¼åŸï¼šå˜çˆ»ä¸æœ¬çˆ»ç›¸åŒï¼Œäº‹å¤šåå¤ï¼Œæ‹–å»¶
- ååŸï¼šå˜çˆ»ä¸æœ¬çˆ»å…­å†²ï¼Œåå¤å˜åŒ–ï¼Œéš¾æˆ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
åä¸€ã€åº”æœŸæ¨æ–­æ³•åˆ™ï¼ˆé¢„æµ‹æ—¶é—´ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ç”¨ç¥æ—ºç›¸ï¼šè¿‘æœŸåº”éªŒï¼Œä»¥æ—¥è®¡
- ç”¨ç¥ä¼‘å›šï¼šè¿œæœŸåº”éªŒï¼Œä»¥æœˆè®¡
- åŠ¨çˆ»åº”æœŸï¼šé€¢å€¼ã€é€¢åˆã€é€¢å†²æ—¶åº”éªŒ
- ç©ºäº¡åº”æœŸï¼šé€¢å€¼å¡«å®ã€é€¢åˆæ—¶åº”éªŒ
- å…¥å¢“åº”æœŸï¼šé€¢å†²å¼€å¢“æ—¶åº”éªŒ
- è¿›ç¥åº”æœŸï¼šé€¢å€¼é€¢åˆæ—¶åº”éªŒ
- é€€ç¥åº”æœŸï¼šé€¢å†²æ—¶åº”éªŒ

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
åäºŒã€ç‰¹æ®Šæ ¼å±€åˆ¤å®š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ç‹¬å‘ï¼šä¸€çˆ»ç‹¬åŠ¨ï¼Œä»¥åŠ¨çˆ»å®šå‰å‡¶
- ä¹±åŠ¨ï¼šå¤šçˆ»é½åŠ¨ï¼Œä»¥ç”¨ç¥ä¸ºä¸»åˆ¤æ–­
- å…­é™ï¼šæ— åŠ¨çˆ»ï¼Œä»¥ç”¨ç¥æ—ºè¡°å®šå‰å‡¶
- æ¸¸é­‚å¦ï¼šäº‹ä¸å®šï¼Œæœ‰å¤–å‡ºä¹‹è±¡
- å½’é­‚å¦ï¼šäº‹æœ‰å½’å®¿ï¼Œæœ‰å›å½’ä¹‹è±¡
"""


def build_interpretation_prompt(hexagram_data: Dict, question: str, style: str, 
                                 advanced_analysis: Optional[Dict] = None) -> str:
    """æ„å»ºAIè§£å¦æç¤ºè¯ï¼ˆå¢å¼ºç‰ˆï¼‰"""
    # æ„å»ºå¦è±¡å¯è§†åŒ–
    lines = hexagram_data.get('lines', [])
    visual_lines = []
    for line in lines:
        line_type = LineType(line['type'])
        visual_lines.append(f"çˆ»{line['index'] + 1}: {get_line_name(line_type)}")
    visual = '\n'.join(visual_lines)
    
    # è·å–é£æ ¼æç¤º
    style_prompt = STYLE_PROMPTS.get(style, STYLE_PROMPTS['detailed'])
    
    # æ„å»ºå…­çˆ»è¯¦æƒ…ï¼ˆå¢å¼ºç‰ˆï¼‰
    yao_details = ""
    yao_names = ['åˆçˆ»', 'äºŒçˆ»', 'ä¸‰çˆ»', 'å››çˆ»', 'äº”çˆ»', 'ä¸Šçˆ»']
    
    for i, line in enumerate(lines):
        fu_shen = line.get('fu_shen')
        fu_shen_str = f"[ä¼ç¥:{fu_shen['relation']}{fu_shen['branch']}]" if fu_shen else ""
        shi_ying = "ã€ä¸–ã€‘" if line.get('is_shi') else ("ã€åº”ã€‘" if line.get('is_ying') else "")
        moving = "â—åŠ¨" if line.get('is_moving') else ""
        changed = f"â†’{line.get('changed_relation', '')}{line.get('changed_branch', '')}" if line.get('is_moving') else ""
        
        # æ·»åŠ é«˜çº§åˆ†æä¿¡æ¯
        advanced_info = ""
        if advanced_analysis and 'extended_yaos' in advanced_analysis:
            ext_yao = advanced_analysis['extended_yaos'][i] if i < len(advanced_analysis['extended_yaos']) else None
            if ext_yao:
                strength = ext_yao.get('strength', {})
                wang_shuai = strength.get('wang_shuai', '')
                special = strength.get('special_status', '')
                kong_wang = ext_yao.get('kong_wang_state', '')
                chang_sheng = ext_yao.get('chang_sheng', {})
                
                markers = []
                if wang_shuai:
                    markers.append(wang_shuai)
                if special and special != 'æ— ':
                    markers.append(special)
                if kong_wang and kong_wang not in ['ä¸ç©º', '']:
                    markers.append(kong_wang)
                if chang_sheng and chang_sheng.get('stage'):
                    markers.append(chang_sheng['stage'])
                
                # åŠ¨çˆ»å˜åŒ–åˆ†æ
                if ext_yao.get('change_analysis'):
                    hua_type = ext_yao['change_analysis'].get('hua_type', '')
                    if hua_type and hua_type != 'æ— ':
                        markers.append(hua_type)
                
                if markers:
                    advanced_info = f"ã€”{'/'.join(markers)}ã€•"
        
        yao_details += f"  {yao_names[i]}ï¼š{line['six_beast']} {line['six_relation']}{line['stem']}{line['branch']} {shi_ying}{moving}{changed} {advanced_info}{fu_shen_str}\n"
    
    # æ„å»ºé«˜çº§åˆ†ææ‘˜è¦
    advanced_summary = ""
    if advanced_analysis:
        # æ—¬ç©ºä¿¡æ¯
        kong_wang = advanced_analysis.get('kong_wang', {})
        if kong_wang:
            advanced_summary += f"\nã€æ—¬ç©ºã€‘{kong_wang.get('xun', '')}ï¼Œç©ºäº¡åœ°æ”¯ï¼š{', '.join(kong_wang.get('kong_dizhi', []))}"
        
        # å…­å†²å¦åˆ¤å®š
        liu_chong = advanced_analysis.get('liu_chong_gua', {})
        if liu_chong.get('is_liu_chong_gua'):
            advanced_summary += f"\nã€å…­å†²å¦ã€‘{liu_chong.get('description', 'æ˜¯')}"
        
        # ä¸‰åˆå±€åˆ†æ
        san_he = advanced_analysis.get('san_he_analysis', {})
        if san_he.get('has_full_san_he') and san_he.get('full_san_he'):
            advanced_summary += f"\nã€ä¸‰åˆå±€ã€‘{san_he['full_san_he'].get('name', '')}ï¼ˆåˆåŠ›å¼ºå¤§ï¼Œå¯è§£å†²è§£ç©ºï¼‰"
        elif san_he.get('has_ban_he') and san_he.get('ban_he'):
            ban_he_info = san_he['ban_he'][0]
            advanced_summary += f"\nã€åŠåˆã€‘{ban_he_info.get('branches', [])}åŠåˆ{ban_he_info.get('result', '')}"
        
        # ç¥ç³»åˆ†æ
        shen_system = advanced_analysis.get('shen_system')
        if shen_system:
            shen_parts = []
            if shen_system.get('yuan_shen'):
                yuan = shen_system['yuan_shen']
                pos_str = f"åœ¨{', '.join([yao_names[p] for p in yuan.get('positions', [])])}" if yuan.get('positions') else "ä¸ä¸Šå¦"
                shen_parts.append(f"åŸç¥{yuan.get('liu_qin', '')}ï¼ˆ{yuan.get('wu_xing', '')}ï¼‰{pos_str}")
            if shen_system.get('ji_shen'):
                ji = shen_system['ji_shen']
                pos_str = f"åœ¨{', '.join([yao_names[p] for p in ji.get('positions', [])])}" if ji.get('positions') else "ä¸ä¸Šå¦"
                shen_parts.append(f"å¿Œç¥{ji.get('liu_qin', '')}ï¼ˆ{ji.get('wu_xing', '')}ï¼‰{pos_str}")
            if shen_system.get('chou_shen'):
                chou = shen_system['chou_shen']
                pos_str = f"åœ¨{', '.join([yao_names[p] for p in chou.get('positions', [])])}" if chou.get('positions') else "ä¸ä¸Šå¦"
                shen_parts.append(f"ä»‡ç¥{chou.get('liu_qin', '')}ï¼ˆ{chou.get('wu_xing', '')}ï¼‰{pos_str}")
            if shen_parts:
                advanced_summary += f"\nã€ç¥ç³»ã€‘{' | '.join(shen_parts)}"
    
    # æ„å»ºå®Œæ•´æç¤ºè¯
    prompt = f"""ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šå‘¨æ˜“ã€‹çš„èµ„æ·±æ˜“å­¦å¤§å¸ˆï¼Œæ·±è°™é‡é¹¤è€äººã€Šå¢åˆ åœæ˜“ã€‹ã€ç‹æ´ªç»ªã€Šåœç­®æ­£å®—ã€‹ä¹‹ç²¾é«“ã€‚

{PROFESSIONAL_PRINCIPLES}

ç”¨æˆ·é—®é¢˜ï¼š"{question or 'æµ‹è¿åŠ¿'}"

ã€å¦è±¡ä¿¡æ¯ã€‘
æœ¬å¦ï¼š{hexagram_data.get('name', 'æœªçŸ¥')}
æ‰€å±å®«ï¼š{hexagram_data.get('palace_name', 'æœªçŸ¥')}
å®«äº”è¡Œï¼š{hexagram_data.get('palace_element', 'æœªçŸ¥')}
å˜å¦ï¼š{hexagram_data.get('transformed_name', 'æ— ')}
{advanced_summary}

ã€å…­çˆ»æ’ç›˜ã€‘(ä»ä¸‹åˆ°ä¸Š)
{yao_details}

{style_prompt}

ã€è§£è¯»è¦æ±‚ã€‘
1. **å¦è±¡æ¦‚è¿°**ï¼šæœ¬å¦è±¡å¾ã€åŸºæœ¬å«ä¹‰ã€å¦è¾è§£è¯»
2. **å…­çˆ»é€çˆ»åˆ†æ**ï¼šä»åˆçˆ»åˆ°ä¸Šçˆ»ï¼Œé€ä¸€åˆ†ææ¯çˆ»çš„æ—ºè¡°ã€ç©ºäº¡ã€æœˆæ—¥ä½œç”¨
3. **ç”¨ç¥è¯¦ç»†åˆ†æ**ï¼šç¡®å®šç”¨ç¥ã€åˆ†æç”¨ç¥æ—ºè¡°ã€ç©ºäº¡ã€æœˆæ—¥ç”Ÿå…‹ã€æ˜¯å¦å¾—ä½å¾—æ—¶
4. **ç¥ç³»å®Œæ•´æ¨æ¼”**ï¼šåŸç¥çŠ¶æ€â†’èƒ½å¦ç”Ÿç”¨ç¥ã€å¿Œç¥çŠ¶æ€â†’æ˜¯å¦å…‹ç”¨ç¥ã€ä»‡ç¥çŠ¶æ€â†’æ˜¯å¦å…‹åŸç¥
5. **åŠ¨çˆ»å˜åŒ–è¯¦è§£**ï¼šæ¯ä¸ªåŠ¨çˆ»çš„å˜åŒ–ç±»å‹ã€å›å¤´ç”Ÿå…‹ã€åŒ–è¿›åŒ–é€€ã€åŒ–ç©ºåŒ–å¢“ç­‰
6. **ä¼ç¥å¯ç”¨æ€§**ï¼šè‹¥ç”¨ç¥ä¸ä¸Šå¦ï¼Œåˆ†æä¼ç¥ä½ç½®ã€é£ç¥å…³ç³»ã€èƒ½å¦å¼•å‡º
7. **ä¸–åº”å…³ç³»**ï¼šä¸–çˆ»ä»£è¡¨å·±æ–¹ã€åº”çˆ»ä»£è¡¨å¯¹æ–¹ï¼Œåˆ†æç”Ÿå…‹æ¯”å’Œå…³ç³»
8. **åº”æœŸæ¨æ–­**ï¼šæ ¹æ®åŠ¨çˆ»ã€ç©ºäº¡å¡«å®ã€å†²åˆç­‰ç»™å‡ºå…·ä½“åº”éªŒæ—¶é—´
9. **ç»¼åˆåˆ¤æ–­**ï¼šæ˜ç¡®å‰å‡¶ç»“è®ºå’Œå…·ä½“è¡ŒåŠ¨å»ºè®®

**é‡è¦ï¼šå¿…é¡»è¯¦å°½åˆ†æï¼Œä¸å¯æ•·è¡ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½è¦å±•å¼€è®ºè¿°ï¼Œè®©æ±‚å¦è€…å……åˆ†ç†è§£æ–­å¦ä¾æ®ã€‚**

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹Markdownæ ¼å¼è¾“å‡ºï¼ˆæ¯ä¸ªéƒ¨åˆ†éƒ½å¿…é¡»è¯¦ç»†å±•å¼€ï¼Œä¸å¯çœç•¥ï¼‰ï¼š

## ğŸ”® å¦åä¸æ ¸å¿ƒæ•°æ®
**[æœ¬å¦å] ä¹‹ [å˜å¦å]**ï¼ˆè‹¥æ— å˜å¦åˆ™åªå†™æœ¬å¦åï¼‰

| é¡¹ç›® | æ•°æ® |
|------|------|
| æœ¬å¦ | [å¦å] |
| å˜å¦ | [å˜å¦å/æ— ] |
| æ‰€å±å®« | [å®«å]å®«ï¼ˆ[äº”è¡Œ]ï¼‰ |
| ä¸–çˆ» | [ç¬¬Xçˆ»] |
| åº”çˆ» | [ç¬¬Xçˆ»] |
| ç”¨ç¥ | [å…­äº²å]ï¼ˆ[åœ°æ”¯]ï¼‰ |
| æˆåŠŸæ¦‚ç‡ | **[XX%]** |
| å‰å‡¶è¯„çº§ | **[å¤§å‰/ä¸­å‰/å°å‰/å¹³/å°å‡¶/ä¸­å‡¶/å¤§å‡¶]** |

---

## âš¡ å¤§å¸ˆæ–­è¯­
> **æ ¸å¿ƒç»“è®º**ï¼š[å‰/å‡¶/å¹³]
> 
> [ä¸¤ä¸‰å¥è¯æ¦‚æ‹¬æ ¸å¿ƒåˆ¤æ–­å’Œå…³é”®ä¾æ®ï¼Œå¿…é¡»åŒ…å«æˆåŠŸæ¦‚ç‡å’Œåº”æœŸ]
> 
> **æˆåŠŸæ¦‚ç‡**ï¼š[XX%]  |  **åº”æœŸ**ï¼š[å…·ä½“æ—¶é—´]

---

## ğŸ“Š å¦è±¡æ€»è§ˆ

### å¦è¾åŸæ–‡
> [å¼•ç”¨ã€Šæ˜“ç»ã€‹åŸæœ¬å¦è¾]

### å¦è±¡è±¡å¾
[è¯¦ç»†è§£é‡Šæœ¬å¦çš„è±¡å¾æ„ä¹‰ã€å¦å¾·ç‰¹ç‚¹]

### å½“å‰é—®é¢˜è§£è¯»
[è¯´æ˜æ­¤å¦åœ¨å½“å‰é—®é¢˜ä¸‹çš„åŸºæœ¬å«ä¹‰å’ŒæŒ‡å‘]

---

## ğŸ” å…­çˆ»é€çˆ»åˆ†æ

### åˆçˆ» [å…­äº²][åœ°æ”¯]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]ï¼ŒåŠ›é‡çº¦[XX%]
- **ç©ºäº¡æƒ…å†µ**ï¼š[çœŸç©º/åŠ¨ç©º/å†²ç©º/ä¸ç©º]
- **æœˆå»ºä½œç”¨**ï¼šæœˆå»º[åœ°æ”¯]å¯¹æ­¤çˆ»[ç”Ÿ/å…‹/æ‰¶/å†²/åˆ]
- **æ—¥è¾°ä½œç”¨**ï¼šæ—¥è¾°[åœ°æ”¯]å¯¹æ­¤çˆ»[ç”Ÿ/å…‹/æ‰¶/å†²/åˆ]
- **ç‰¹æ®ŠçŠ¶æ€**ï¼š[æš—åŠ¨/æ—¥ç ´/å…¥å¢“/æ— ]
- **åäºŒé•¿ç”Ÿ**ï¼š[é•¿ç”Ÿ/æ²æµ´/å† å¸¦/ä¸´å®˜/å¸æ—º/è¡°/ç—…/æ­»/å¢“/ç»/èƒ/å…»]
- **å…­ç¥å«ä¹‰**ï¼š[å…­ç¥å]ä¸»[å«ä¹‰è§£é‡Š]
- **æ–­è¯­**ï¼š[æ­¤çˆ»å¯¹é—®äº‹çš„å½±å“]

### äºŒçˆ» [å…­äº²][åœ°æ”¯]
[åŒä¸Šæ ¼å¼è¯¦ç»†åˆ†æ]

### ä¸‰çˆ» [å…­äº²][åœ°æ”¯]
[åŒä¸Šæ ¼å¼è¯¦ç»†åˆ†æ]

### å››çˆ» [å…­äº²][åœ°æ”¯]
[åŒä¸Šæ ¼å¼è¯¦ç»†åˆ†æ]

### äº”çˆ» [å…­äº²][åœ°æ”¯]
[åŒä¸Šæ ¼å¼è¯¦ç»†åˆ†æ]

### ä¸Šçˆ» [å…­äº²][åœ°æ”¯]
[åŒä¸Šæ ¼å¼è¯¦ç»†åˆ†æ]

---

## ğŸ¯ ç”¨ç¥æ·±åº¦åˆ†æ

### 1. ç”¨ç¥ç¡®å®š
- **é—®äº‹ç±»å‹**ï¼š[è´¢è¿/äº‹ä¸š/æ„Ÿæƒ…/å¥åº·/...]
- **ç”¨ç¥å…­äº²**ï¼š[å¦»è´¢/å®˜é¬¼/å­å­™/çˆ¶æ¯/å…„å¼Ÿ]
- **ç¡®å®šä¾æ®**ï¼š[è§£é‡Šä¸ºä½•å–æ­¤å…­äº²ä¸ºç”¨ç¥]

### 2. ç”¨ç¥çŠ¶æ€è¯„ä¼°
- **æ‰€åœ¨çˆ»ä½**ï¼š[ç¬¬Xçˆ»]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]
- **ç©ºäº¡æƒ…å†µ**ï¼š[çœŸç©º/åŠ¨ç©º/å†²ç©º/ä¸ç©º]
- **æ˜¯å¦åŠ¨çˆ»**ï¼š[æ˜¯/å¦]
- **åäºŒé•¿ç”Ÿ**ï¼š[çŠ¶æ€]
- **ç”¨ç¥åŠ›é‡**ï¼š**[XX%]**

### 3. æœˆæ—¥ä½œç”¨åˆ†æ
- **æœˆå»ºä½œç”¨**ï¼šæœˆå»º[åœ°æ”¯]å¯¹ç”¨ç¥[ç”Ÿ/å…‹/æ‰¶/å†²/åˆ]ï¼Œ[å¢å¼º/å‰Šå¼±]ç”¨ç¥åŠ›é‡çº¦[X%]
- **æ—¥è¾°ä½œç”¨**ï¼šæ—¥è¾°[åœ°æ”¯]å¯¹ç”¨ç¥[ç”Ÿ/å…‹/æ‰¶/å†²/åˆ]ï¼Œ[å¢å¼º/å‰Šå¼±]ç”¨ç¥åŠ›é‡çº¦[X%]

### 4. ç»¼åˆåˆ¤æ–­
[ç”¨ç¥æœ‰åŠ›è¿˜æ˜¯æ— åŠ›ï¼Œå¾—æ—¶è¿˜æ˜¯å¤±æ—¶ï¼Œå¯¹é—®äº‹çš„å½±å“]

---

## ğŸ”— ç¥ç³»ä½œç”¨é“¾æ¨æ¼”

### åŸç¥åˆ†æï¼ˆç”Ÿç”¨ç¥è€…ï¼‰
- **åŸç¥å…­äº²**ï¼š[å…­äº²å]
- **äº”è¡Œå±æ€§**ï¼š[äº”è¡Œ]
- **å¦ä¸­ä½ç½®**ï¼š[ç¬¬Xçˆ»/ä¸ä¸Šå¦]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]
- **èƒ½å¦ç”Ÿç”¨ç¥**ï¼š[èƒ½/ä¸èƒ½]ï¼Œç”ŸåŠ›çº¦[XX%]
- **æ–­è¯­**ï¼š[åŸç¥å¯¹ç”¨ç¥çš„å®é™…ä½œç”¨]

### å¿Œç¥åˆ†æï¼ˆå…‹ç”¨ç¥è€…ï¼‰
- **å¿Œç¥å…­äº²**ï¼š[å…­äº²å]
- **äº”è¡Œå±æ€§**ï¼š[äº”è¡Œ]
- **å¦ä¸­ä½ç½®**ï¼š[ç¬¬Xçˆ»/ä¸ä¸Šå¦]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]
- **æ˜¯å¦å‘åŠ¨**ï¼š[æ˜¯/å¦]
- **å…‹åŠ›å¤§å°**ï¼šçº¦[XX%]
- **æ–­è¯­**ï¼š[å¿Œç¥å¯¹ç”¨ç¥çš„å®é™…å¨èƒ]

### ä»‡ç¥åˆ†æï¼ˆå…‹åŸç¥è€…ï¼‰
- **ä»‡ç¥å…­äº²**ï¼š[å…­äº²å]
- **äº”è¡Œå±æ€§**ï¼š[äº”è¡Œ]
- **å¦ä¸­ä½ç½®**ï¼š[ç¬¬Xçˆ»/ä¸ä¸Šå¦]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]
- **æ˜¯å¦åˆ¶çº¦åŸç¥**ï¼š[æ˜¯/å¦]
- **æ–­è¯­**ï¼š[ä»‡ç¥çš„é—´æ¥å½±å“]

### ç¥ç³»ä½œç”¨é“¾æ€»ç»“
```
ä»‡ç¥[XX%] â”€â”€å…‹â”€â”€â†’ åŸç¥[XX%] â”€â”€ç”Ÿâ”€â”€â†’ ç”¨ç¥[XX%] â†â”€â”€å…‹â”€â”€ å¿Œç¥[XX%]
```
[ç»¼åˆåˆ†æç¥ç³»ä½œç”¨é“¾å¯¹é—®äº‹çš„æœ€ç»ˆå½±å“]

---

## ğŸ”„ åŠ¨çˆ»å˜åŒ–è¯¦è§£

### åŠ¨çˆ»åˆ—è¡¨
| çˆ»ä½ | æœ¬çˆ» | å˜çˆ» | å˜åŒ–ç±»å‹ | å‰å‡¶ |
|------|------|------|----------|------|
| [ç¬¬Xçˆ»] | [å…­äº²][åœ°æ”¯] | [å…­äº²][åœ°æ”¯] | [åŒ–è¿›/åŒ–é€€/å›å¤´ç”Ÿ/å›å¤´å…‹/åŒ–ç©º/åŒ–å¢“/ä¼åŸ/ååŸ] | [å‰/å‡¶] |

### åŠ¨çˆ»è¯¦ç»†åˆ†æ
[è‹¥æœ‰åŠ¨çˆ»ï¼Œé€ä¸ªåˆ†ææ¯ä¸ªåŠ¨çˆ»çš„å˜åŒ–ç±»å‹åŠå…¶å‰å‡¶å«ä¹‰]
[è‹¥æ— åŠ¨çˆ»ï¼Œåˆ†æé™å¦çš„ç‰¹ç‚¹ï¼šå…­é™å¦ä»¥ç”¨ç¥æ—ºè¡°å®šå‰å‡¶]

---

## ğŸ‘¥ ä¸–åº”å…³ç³»æ·±åº¦åˆ†æ

### ä¸–çˆ»åˆ†æï¼ˆä»£è¡¨æ±‚å¦äººï¼‰
- **æ‰€åœ¨çˆ»ä½**ï¼š[ç¬¬Xçˆ»]
- **å…­äº²å…­ç¥**ï¼š[å…­äº²][å…­ç¥]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]
- **ç‰¹æ®ŠçŠ¶æ€**ï¼š[åŠ¨/é™/ç©ºäº¡/å…¥å¢“ç­‰]
- **ä¸»åŠ¨æƒè¯„ä¼°**ï¼š[æ±‚å¦äººåœ¨æ­¤äº‹ä¸­çš„ä¸»åŠ¨æƒå¤§å°]

### åº”çˆ»åˆ†æï¼ˆä»£è¡¨å¯¹æ–¹/äº‹æƒ…/ç¯å¢ƒï¼‰
- **æ‰€åœ¨çˆ»ä½**ï¼š[ç¬¬Xçˆ»]
- **å…­äº²å…­ç¥**ï¼š[å…­äº²][å…­ç¥]
- **æ—ºè¡°çŠ¶æ€**ï¼š[æ—º/ç›¸/ä¼‘/å›š/æ­»]
- **ç‰¹æ®ŠçŠ¶æ€**ï¼š[åŠ¨/é™/ç©ºäº¡/å…¥å¢“ç­‰]
- **å¯¹æ–¹/ç¯å¢ƒè¯„ä¼°**ï¼š[å¯¹æ–¹æˆ–ç¯å¢ƒå¯¹æ­¤äº‹çš„æ€åº¦å’Œå½±å“]

### ä¸–åº”ç”Ÿå…‹å…³ç³»
- **å…³ç³»ç±»å‹**ï¼š[ä¸–ç”Ÿåº”/åº”ç”Ÿä¸–/ä¸–å…‹åº”/åº”å…‹ä¸–/ä¸–åº”æ¯”å’Œ]
- **åŠ›é‡å¯¹æ¯”**ï¼šä¸–çˆ»[XX%] vs åº”çˆ»[XX%]
- **å«ä¹‰è§£è¯»**ï¼š[è¿™ç§å…³ç³»å¯¹é—®äº‹çš„å…·ä½“å½±å“]

---

## â° åº”æœŸç²¾å‡†æ¨æ–­

### åº”æœŸæ¨æ–­ä¾æ®
| å› ç´  | çŠ¶æ€ | åº”æœŸæ¨æ–­ |
|------|------|----------|
| ç”¨ç¥çŠ¶æ€ | [æ—ºç›¸/ä¼‘å›š] | [ä»¥æ—¥è®¡/ä»¥æœˆè®¡] |
| åŠ¨çˆ»å˜åŒ– | [æœ‰/æ— ] | [é€¢Xæ—¥/æœˆ] |
| ç©ºäº¡å¡«å® | [ç”¨ç¥ç©ºäº¡/ä¸ç©º] | [é€¢Xæ—¥/æœˆå¡«å®] |
| å…¥å¢“å‡ºå¢“ | [å…¥å¢“/ä¸å…¥å¢“] | [é€¢Xæ—¥/æœˆå†²å¼€] |
| å†²åˆå…³ç³» | [å¾…å†²/å¾…åˆ] | [é€¢Xæ—¥/æœˆ] |

### å…·ä½“åº”æœŸç»“è®º
- **æœ€ä½³æ—¶æœº**ï¼š**[å†œå†XæœˆXæ—¥/å…¬å†XæœˆXæ—¥å‰å]**
- **æ¬¡ä½³æ—¶æœº**ï¼š[å¤‡é€‰æ—¶é—´]
- **åº”é¿å¼€æ—¶é—´**ï¼š[ä¸åˆ©æ—¶é—´æ®µ]
- **åº”æœŸç½®ä¿¡åº¦**ï¼š[é«˜/ä¸­/ä½]

---

## ğŸ“ˆ é‡åŒ–è¯„ä¼°æ€»è¡¨

| è¯„ä¼°ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|----------|------|------|
| ç”¨ç¥åŠ›é‡ | [XX%] | [ç®€è¦è¯´æ˜] |
| åŸç¥åŠ©åŠ› | [XX%] | [ç®€è¦è¯´æ˜] |
| å¿Œç¥å¨èƒ | [XX%] | [ç®€è¦è¯´æ˜] |
| ä¸–çˆ»çŠ¶æ€ | [XX%] | [ç®€è¦è¯´æ˜] |
| **ç»¼åˆæˆåŠŸç‡** | **[XX%]** | [ç»¼åˆåˆ¤æ–­] |
| **å‰å‡¶è¯„çº§** | **[å¤§å‰/ä¸­å‰/å°å‰/å¹³/å°å‡¶/ä¸­å‡¶/å¤§å‡¶]** | [è¯„çº§ä¾æ®] |
| **å‘å±•è¶‹åŠ¿** | **[ä¸Šå‡/å¹³ç¨³/ä¸‹é™]** | [è¶‹åŠ¿è¯´æ˜] |

---

## ğŸ’¡ ç»¼åˆå»ºè®®ä¸æŒ‡å¯¼

### 1. æ€»ä½“åˆ¤æ–­
- **å‰å‡¶ç»“è®º**ï¼š**[å‰/å‡¶/å¹³]**
- **åˆ¤æ–­ä¾æ®**ï¼š[åˆ—å‡º3-5ä¸ªå…³é”®åˆ¤æ–­ä¾æ®]
- **æˆåŠŸæ¦‚ç‡**ï¼š**[XX%]**

### 2. å…·ä½“è¡ŒåŠ¨å»ºè®®
- **å®œ**ï¼š[å…·ä½“å¯åšçš„äº‹æƒ…ï¼Œ2-3æ¡]
- **å¿Œ**ï¼š[éœ€è¦é¿å…çš„äº‹æƒ…ï¼Œ2-3æ¡]
- **æœ€ä½³è¡ŒåŠ¨æ—¶æœº**ï¼š[å…·ä½“æ—¶é—´]

### 3. é£é™©æç¤ºä¸æ³¨æ„äº‹é¡¹
- **ä¸»è¦é£é™©**ï¼š[å¯èƒ½é‡åˆ°çš„é—®é¢˜]
- **é˜²èŒƒæªæ–½**ï¼š[å¦‚ä½•è§„é¿é£é™©]
- **å…³é”®æ—¶é—´èŠ‚ç‚¹**ï¼š[éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ—¶é—´]

### 4. å¼€è¿è°ƒç†å»ºè®®
- **äº”è¡Œè°ƒç†**ï¼š[æ ¹æ®ç”¨ç¥äº”è¡Œç»™å‡ºé¢œè‰²ã€æ–¹ä½ã€æ•°å­—ç­‰å»ºè®®]
- **è¡Œä¸ºè°ƒæ•´**ï¼š[å…·ä½“è¡Œä¸ºå»ºè®®]
- **å¿ƒæ€è°ƒæ•´**ï¼š[å¿ƒç†å»ºè®®]

---

## ğŸ”š ç»“è¯­
[ä»¥æ˜“å­¦å¤§å¸ˆå£å»ç»™å‡ºæœ€ç»ˆå¯„è¯­ï¼Œé¼“åŠ±æˆ–æé†’æ±‚å¦è€…ï¼Œå……åˆ†è¡¨è¾¾æ™ºæ…§ä¸å…³æ€€]
"""
    
    return prompt


# ========== AIæœåŠ¡åŸºç±» ==========

class BaseAIService(ABC):
    """AIæœåŠ¡åŸºç±»"""
    
    @abstractmethod
    async def generate_interpretation(self, hexagram_data: Dict, question: str, style: str) -> str:
        """ç”Ÿæˆè§£å¦ç»“æœ"""
        pass


# ========== Gemini AIæœåŠ¡ ==========

class GeminiAIService(BaseAIService):
    """Gemini AIæœåŠ¡"""
    
    def __init__(self):
        self.api_key = getattr(settings, 'gemini_api_key', None)
        self.model = getattr(settings, 'gemini_model', 'gemini-2.5-flash')
        self.client = None

        if self.api_key:
            try:
                import google.generativeai as genai
                genai.configure(api_key=self.api_key)
                self.client = genai
                _logger.info(f"Gemini AIæœåŠ¡åˆå§‹åŒ–æˆåŠŸ (æ¨¡å‹: {self.model})")
            except ImportError:
                _logger.warning("æœªå®‰è£…google-generativeaiåŒ…ï¼ŒGeminiæœåŠ¡ä¸å¯ç”¨")
            except Exception as e:
                _logger.error(f"Geminiåˆå§‹åŒ–å¤±è´¥: {e}")
    
    async def generate_interpretation(self, hexagram_data: Dict, question: str, style: str,
                                       advanced_analysis: Optional[Dict] = None) -> str:
        """ä½¿ç”¨Geminiç”Ÿæˆè§£å¦"""
        if not self.client:
            raise RuntimeError("GeminiæœåŠ¡æœªåˆå§‹åŒ–")

        prompt = build_interpretation_prompt(hexagram_data, question, style, advanced_analysis)

        try:
            model = self.client.GenerativeModel(self.model)
            response = await model.generate_content_async(prompt)
            return response.text
        except Exception as e:
            _logger.error(f"Gemini APIè°ƒç”¨å¤±è´¥: {e}")
            raise RuntimeError(f"Geminiè§£å¦å¤±è´¥: {str(e)}")


# ========== OpenAI AIæœåŠ¡ ==========

class OpenAIAIService(BaseAIService):
    """OpenAIå…¼å®¹APIæœåŠ¡ï¼ˆæ”¯æŒDeepSeekã€æ™ºè°±AIã€é˜¿é‡Œäº‘ç™¾ç‚¼ç­‰ï¼‰"""
    
    def __init__(self, api_key: Optional[str] = None, api_base: Optional[str] = None, model: Optional[str] = None):
        self.api_key = api_key or settings.api_key
        self.api_base = api_base or settings.api_base
        self.model = model or getattr(settings, 'model', 'gpt-3.5-turbo')
        
        # æ¸…ç†APIå¯†é’¥
        if self.api_key:
            self.api_key = self.api_key.strip().replace('\xa0', '').replace('\u200b', '')
            if self.api_key.startswith("Bearer "):
                self.api_key = self.api_key[7:].strip()
        
        if self.api_key and self.api_base:
            self.client = AsyncOpenAI(
                api_key=self.api_key, 
                base_url=self.api_base,
                timeout=60.0,
                max_retries=0
            )
            _logger.info(f"OpenAIå…¼å®¹æœåŠ¡åˆå§‹åŒ–æˆåŠŸ: {self.api_base}")
        else:
            self.client = None
            _logger.warning("æœªé…ç½®API Keyæˆ–API Base URL")
    
    async def generate_interpretation(self, hexagram_data: Dict, question: str, style: str,
                                       advanced_analysis: Optional[Dict] = None) -> str:
        """ä½¿ç”¨OpenAIå…¼å®¹APIç”Ÿæˆè§£å¦"""
        if not self.client:
            raise RuntimeError("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Keyå’ŒAPI Base URL")
        
        prompt = build_interpretation_prompt(hexagram_data, question, style, advanced_analysis)
        
        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                max_tokens=32000,  # ç”¨æˆ·ä½“éªŒä¼˜å…ˆï¼šæ— é™åˆ¶è¾“å‡º
                temperature=0.75,
                messages=[
                    {
                        "role": "system",
                        "content": """ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šå‘¨æ˜“ã€‹çš„èµ„æ·±æ˜“å­¦å¤§å¸ˆï¼Œæ·±è°™é‡é¹¤è€äººã€Šå¢åˆ åœæ˜“ã€‹ã€ç‹æ´ªç»ªã€Šåœç­®æ­£å®—ã€‹ã€åˆ˜ä¼¯æ¸©ã€Šé»„é‡‘ç­–ã€‹ä¹‹ç²¾é«“ã€‚

ã€ä½ çš„ä¸“ä¸šèƒŒæ™¯ã€‘
- ç ”ä¹ æ˜“å­¦äº”åä½™å¹´ï¼Œç²¾é€šå…­çˆ»çº³ç”²ã€æ¢…èŠ±æ˜“æ•°ã€å¥‡é—¨éç”²
- å¯¹æœˆå»ºæ—¥è¾°ã€æ—ºè¡°ç©ºäº¡ã€ç”¨ç¥ç¥ç³»æœ‰æ·±åˆ»ç†è§£
- æ“…é•¿é‡åŒ–åˆ†æï¼Œèƒ½ç»™å‡ºç²¾å‡†çš„æˆåŠŸæ¦‚ç‡å’Œåº”æœŸæ¨æ–­

ã€è§£è¯»åŸåˆ™ã€‘
1. å¿…é¡»é€çˆ»è¯¦ç»†åˆ†æï¼Œä¸å¯æ•·è¡çœç•¥
2. å¿…é¡»ç»™å‡ºæ˜ç¡®çš„æˆåŠŸæ¦‚ç‡ï¼ˆå¦‚75%ï¼‰
3. å¿…é¡»ç»™å‡ºå…·ä½“çš„åº”æœŸï¼ˆå¦‚å†œå†Xæœˆã€Xæ—¥å‰åï¼‰
4. å¿…é¡»ä½¿ç”¨æ ‡å‡†å…­çˆ»æœ¯è¯­
5. åˆ†æè¦æœ‰ç†æœ‰æ®ï¼Œæ¯ä¸ªåˆ¤æ–­éƒ½è¦è¯´æ˜ä¾æ®
6. å¿…é¡»ä½¿ç”¨Markdownæ ¼å¼ï¼Œå±‚æ¬¡æ¸…æ™°
7. è¾“å‡ºè¦è¯¦å°½ä¸“ä¸šï¼Œä½“ç°å…­çˆ»é¢„æµ‹çš„ç²¾å‡†æ€§

è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„å¦è±¡è¿›è¡Œæœ€ä¸“ä¸šã€æœ€è¯¦å°½ã€æœ€å…¨é¢çš„è§£è¯»ã€‚"""
                    },
                    {"role": "user", "content": prompt}
                ]
            )
            return response.choices[0].message.content
        except Exception as e:
            _logger.error(f"APIè°ƒç”¨å¤±è´¥: {e}")
            raise RuntimeError(f"AIè§£å¦å¤±è´¥: {str(e)}")


# ========== ç»Ÿä¸€AIæœåŠ¡ ==========

class LiuYaoAIService:
    """
    ç»Ÿä¸€å…­çˆ»AIæœåŠ¡
    åç«¯è‡ªåŠ¨åˆ¤æ–­ï¼šä¼˜å…ˆä½¿ç”¨Geminiï¼Œæœªé…ç½®åˆ™ä½¿ç”¨OpenAI
    """
    
    def __init__(self, custom_api_key: Optional[str] = None, 
                 custom_api_base: Optional[str] = None,
                 custom_model: Optional[str] = None):
        """
        åˆå§‹åŒ–AIæœåŠ¡
        custom_api_key: è‡ªå®šä¹‰API Key (ç”¨äºå‰ç«¯ä¼ å…¥)
        custom_api_base: è‡ªå®šä¹‰API Base URL
        custom_model: è‡ªå®šä¹‰æ¨¡å‹
        """
        self.custom_api_key = custom_api_key
        self.custom_api_base = custom_api_base
        self.custom_model = custom_model
        
        # åˆ¤æ–­ä½¿ç”¨å“ªä¸ªAI
        self.provider = self._determine_provider()
        _logger.info(f"å…­çˆ»AIæœåŠ¡ä½¿ç”¨: {self.provider}")
    
    def _determine_provider(self) -> str:
        """åˆ¤æ–­ä½¿ç”¨å“ªä¸ªAIæä¾›å•†"""
        # å¦‚æœæœ‰è‡ªå®šä¹‰API Keyï¼Œä½¿ç”¨OpenAIå…¼å®¹æ¥å£
        if self.custom_api_key:
            return 'openai'
        
        # ä¼˜å…ˆæ£€æŸ¥Geminié…ç½®
        gemini_key = getattr(settings, 'gemini_api_key', None)
        if gemini_key:
            try:
                import google.generativeai
                return 'gemini'
            except ImportError:
                _logger.warning("Gemini API Keyå·²é…ç½®ä½†æœªå®‰è£…SDKï¼Œé™çº§åˆ°OpenAI")
        
        # é»˜è®¤ä½¿ç”¨OpenAI
        return 'openai'
    
    async def interpret(self, hexagram_data: Dict, question: str = "", 
                       style: str = "detailed",
                       advanced_analysis: Optional[Dict] = None) -> str:
        """
        AIè§£å¦ï¼ˆå¢å¼ºç‰ˆï¼‰
        hexagram_data: å¦è±¡æ•°æ® (æ¥è‡ªhexagram_to_dict)
        question: ç”¨æˆ·é—®é¢˜
        style: è§£å¦é£æ ¼ (concise/detailed/philosophical)
        advanced_analysis: é«˜çº§åˆ†ææ•°æ®ï¼ˆç©ºäº¡/æ—ºè¡°/ç¥ç³»ç­‰ï¼‰
        """
        if style not in STYLE_PROMPTS:
            style = 'detailed'
        
        try:
            if self.provider == 'gemini':
                service = GeminiAIService()
                return await service.generate_interpretation(hexagram_data, question, style, advanced_analysis)
            else:
                service = OpenAIAIService(
                    api_key=self.custom_api_key,
                    api_base=self.custom_api_base,
                    model=self.custom_model
                )
                return await service.generate_interpretation(hexagram_data, question, style, advanced_analysis)
        except Exception as e:
            _logger.error(f"AIè§£å¦å¤±è´¥: {e}")
            # å¦‚æœGeminiå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°OpenAI
            if self.provider == 'gemini':
                _logger.info("Geminiå¤±è´¥ï¼Œå°è¯•é™çº§åˆ°OpenAI")
                try:
                    service = OpenAIAIService()
                    return await service.generate_interpretation(hexagram_data, question, style, advanced_analysis)
                except Exception as e2:
                    raise RuntimeError(f"æ‰€æœ‰AIæœåŠ¡å‡å¤±è´¥: Gemini({e}), OpenAI({e2})")
            raise
